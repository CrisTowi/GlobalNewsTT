{% extends 'base.html' %}

{% block contenido %}
<div class="col-lg-9">
    <!-- /.panel -->
    <div class="panel panel-default">
        <div class="panel-heading">
            Perfil
        </div>
        <!-- /.panel-heading -->
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-5">
                    <img class="img-responsive" src="{{ MEDIA_URL }}{{ perfil.foto }}">
                </div>
                <div class="col-lg-7">
                    <h3>Username: </h3> <span style="font-size: 20px">{{ perfil.username }}</span>
                    <h3>Nombre: </h3> <span style="font-size: 20px">{{ perfil.nombre }}</span>
                    <h3>Apellido Paterno: </h3> <span style="font-size: 20px">{{ perfil.ap_paterno }}</span>
                    <h3>Apellido Materno: </h3> <span style="font-size: 20px">{{ perfil.ap_materno }}</span>
                    <br><br>
                    <a href="/lista/seguidores/{{ perfil.id }}">{{ numero_seguidores }} Seguidores</a> &nbsp;&nbsp;&nbsp;
                    <a href="/lista/seguidos/{{ perfil.id }}">{{ numero_siguiendo }} Siguiendo</a>
                    {% if user.id == perfil.id %}
                    <br><br>
                    <a class="btn btn-success" href="/editar/perfil/{{ perfil.id }}">Editar</a>
                    {% else %}
                    <br><br><br><br>
                    <a class="btn btn-success" href="/lista/nota/usuario/{{ perfil.id }}">Publicaciones</a>
                    {% if user.is_authenticated %}
                        {% if follow %}
                            <a href="/unfollow/{{ perfil.id }}" class="btn btn-danger">Dejar de Seguir</a>
                        {% else %}
                            <a href="/seguir/{{ perfil.id }}" class="btn btn-success">Seguir</a>
                        {% endif %}
                        <a href="#" data-toggle="modal" class="btn-abre-platica btn btn-info" data-chat="{{ chat.id }}" id="btn-abre-platica" data-usuario="{{ perfil.id }}" data-imagen="{{ perfil.foto }}" data-username="{{ perfil.username }}" data-target="#ModalMD">Enviar Mensaje</a>
                    <br><br>
                    <a href="#" data-toggle="modal" data-target="#ModalDenunciar">Denunciar</a>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
</div>

<!-- Modal -->
<div class="modal fade" id="ModalSeguir" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">{{ perfil.username }}</h4>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-lg-4">
                <h4>Seguidores:</h4>
                <p><h4>123</h4></p>
            </div>
            <div class="col-lg-4">
                <h4>Siguiendo:</h4>
                <p><h4>32</h4></p>
            </div>
            <div class="col-lg-4">
                <h4>Publicaciones:</h4>
                <p><h4>500</h4></p>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="ModalDenunciar" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Reportar: {{ perfil.username }}</h4>
      </div>
      <div class="modal-body">
        <form role="form" method="POST" action="/nuevo_reporte_perfil/" enctype="multipart/form-data">{% csrf_token %}
            {{ form.as_p }}
            <input type="hidden" name="perfil_id" value="{{ perfil.id }}">
            <br>
            <br>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Denunciar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="ModalMD" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Mensajes con: <span id="nombre-usuario-chat"></span></h4>
      </div>
      <div class="modal-body">
        <ul class="chat" id="chat">
        </ul>
      </div>
      <div class="modal-footer">
        <div class="row">
            <div class="col-md-2">
                <button class="btn btn-success" id="btn-enviar">Enviar</button>
            </div>
            <div class="col-md-10">
                <input type="text" id="mensaje" class="form-control" placeholder="Mensaje...">
            </div>
        </div>
      </div>
      <div id="alerta-mensaje" class="alert alert-danger" role="alert">¡No puedes enviar un mensaje vacio!</div>
    </div>
  </div>
</div>
<input type="hidden" id="input_usuario" value="{{ user.id }}"></input>
<input type="hidden" id="media_url" value="{{ MEDIA_URL }}"></input>
{% endblock %}

{% block js %}
<script type="text/javascript">

$('.btn-abre-platica').on('click', function(e){
    e.preventDefault();
    var alerta = $('#alerta-mensaje');
    alerta.hide();

    $("#btn-enviar").off('click');
    $('#chat').html("");

    console.log("{{ user.foto }}");

    var id_usuario = $(this).data("usuario");
    var username_chat = $(this).data("username");
    var imagen = $(this).data("imagen");
    var username_local = "{{ user.username }}";
    var usuario = $('#input_usuario').val();
    var media_url = $('#media_url').val();
    var imagen_local = "{{ user.foto }}"
    $('#nombre-usuario-chat').html(username_chat);

    var id_chat = "";

    console.log('HOLA');

    $.get( "/get/chat/{{ perfil.id }}", function(data){
        id_chat = data.id;
        socket.emit('abrir_chat', id_chat);
    });

    var mensaje_entrada = function(objeto){
        console.log('Mensaje de entrada');
        var imagen_url = media_url + imagen_local
                if(objeto.usuario_remitente == id_usuario){ 
        var imagen_url = media_url + imagen;
        var template = $('<li class="left clearfix"> \
                            <span class="chat-img pull-left"> \
                                <img src=" ' + imagen_url + ' " alt="User Avatar" width="50px" class="img-circle" /> \
                            </span> \
                            <div class="chat-body clearfix"> \
                                <div class="header"> \
                                    <strong class="primary-font">' + username_chat + '</strong> \
                                    <small class="pull-right text-muted"> \
                                        <i class="fa fa-clock-o fa-fw"></i> ' + objeto.fecha + ' \
                                    </small> \
                                </div> \
                                <p> \
                                    ' + objeto.contenido + ' \
                                </p> \
                            </div> \
                        </li>');
                } else {
        var imagen_url = media_url + imagen_local
        var template = $('<li class="right clearfix"> \
                            <span class="chat-img pull-right"> \
                                <img src="' + imagen_url + '" alt="User Avatar" width="50px" class="img-circle" /> \
                            </span> \
                            <div class="chat-body clearfix"> \
                                <div class="header"> \
                                    <small class=" text-muted"> \
                                        <i class="fa fa-clock-o fa-fw"></i>' + objeto.fecha + '</small> \
                                    <strong class="pull-right primary-font">' + username_local + '</strong> \
                                </div> \
                                <p> \
                                    '+ objeto.contenido +' \
                                </p> \
                                <a href="#" class="eliminar" data-id="' + objeto.id + '">Eliminar</a> \
                            </div> \
                        </li>');
                }



           template.hide();
           $('#chat').append(template);
           template.show('slow');


           $('#mensaje').val('');      
    }

    socket.addEventListener('mensaje_entrada', mensaje_entrada);


    $('#ModalMD').on('hidden.bs.modal', function () {
        socket.removeEventListener('mensaje_entrada', mensaje_entrada);
    });

    obtenerChat(id_usuario, username_chat, imagen, username_local, usuario, media_url, imagen_local);
    $('#btn-enviar').on('click', function(){
        var mensaje = $('#mensaje').val();
        if (mensaje == '') {
          alerta.fadeIn('slow');
          setTimeout(function() {
            alerta.fadeOut('slow');
          }, 3000);
        } else {
          var info = {usuario_consultor: usuario , usuario_chat: id_usuario, mensaje: mensaje, id_chat: id_chat};
          console.log(info);
          socket.emit('nuevo_mensaje_chat', info);
        }
    });

    $(document).on("click", ".eliminar", function(){
      event.preventDefault();
      var id = $(this).data("id");
        $.get( "/eliminar/mensaje/", {id: id}, function(data){
          $('#chat').html("");
          var n = noty({
              text: 'Mensaje eliminado con éxico',
              layout: 'bottomRight',
              type: 'success',
              timeout: 3500,
              callback: { onClose: function() { /* Go to the URL i want to go */ }},
              animation: {
                  open: {height: 'toggle'}, // jQuery animate function property object
                  close: {height: 'toggle'}, // jQuery animate function property object
                  easing: 'swing', // easing
                  speed: 500 // opening & closing animation speed
              }
          });
          $(document).unbind("click", ".eliminar");
          obtenerChat(id_usuario, username_chat, imagen, username_local, usuario, media_url, imagen_local);
        });
    });
});

function obtenerChat(id_usuario, username_chat, imagen, username_local, usuario, media_url, imagen_local){
$.ajax({
          url: "{% url 'get_chat' %}",
          type: "GET", //send it through get method
          data: {usuario_consultor: usuario , usuario_chat: id_usuario},
          success: function(response) {
    
            $.each(response, function(i, objeto){



                if(objeto.usuario_remitente_id == id_usuario){ 
        var imagen_url = media_url + imagen;
        var template = '<li class="left clearfix"> \
                            <span class="chat-img pull-left"> \
                                <img src=" ' + imagen_url + ' " alt="User Avatar" width="50px" class="img-circle" /> \
                            </span> \
                            <div class="chat-body clearfix"> \
                                <div class="header"> \
                                    <strong class="primary-font">' + username_chat + '</strong> \
                                    <small class="pull-right text-muted"> \
                                        <i class="fa fa-clock-o fa-fw"></i> ' + objeto.fecha + ' \
                                    </small> \
                                </div> \
                                <p> \
                                    ' + objeto.contenido + ' \
                                </p> \
                            </div> \
                        </li>';
                } else {
        var imagen_url = media_url + imagen_local
        var template = '<li class="right clearfix"> \
                            <span class="chat-img pull-right"> \
                                <img src="' + imagen_url + '" alt="User Avatar" width="50px" class="img-circle" /> \
                            </span> \
                            <div class="chat-body clearfix"> \
                                <div class="header"> \
                                    <small class=" text-muted"> \
                                        <i class="fa fa-clock-o fa-fw"></i>' + objeto.fecha + '</small> \
                                    <strong class="pull-right primary-font">' + username_local + '</strong> \
                                </div> \
                                <p> \
                                    '+ objeto.contenido +' \
                                </p> \
                                <a href="#" class="eliminar" data-id="' + objeto.id + '">Eliminar</a> \
                            </div> \
                        </li>';
                }
            $('#chat').prepend(template);
        });
      }
});
}

</script>

{% endblock %}